+++
title = "[4] WebP: A Case Study in the Hidden Vulnerabilities of Image Formats"
date = 2024-05-10
weight = 2
draft = true

[taxonomies]
categories = ["programming"]
tags = ["infosec", "webp", "vulnerability"]
+++

Hacked by an image? How is that possible? You might have thought that image formats were relatively safe from security vulnerabilities. After all, how could a simple image file pose a threat to your system? This is the story of how a seemingly innocuous image format, WebP, was recently found to have a critical vulnerability that could be exploited to execute arbitrary code on a victim's machine.

<!-- more -->

## Understanding Image Formats

Under the hood, images are just binary data that represent pixels on a screen. Different image formats encode this data in various ways, each with its own strengths and weaknesses. Some formats, like JPEG and PNG, are well-known and widely used. Others, like WebP, are newer and less common but offer advantages such as better compression and transparency support. You'll often hear about image formats being "lossy" or "lossless." Lossy formats, like JPEG, discard some image data to achieve higher compression ratios, while lossless formats, like PNG, preserve all the original data. WebP is unique in that it can be both lossy and lossless, depending on the settings used during encoding. This flexibility makes it a popular choice for web developers looking to balance image quality and file size.

## The Complexity of Huffman Encoding

WebP's lossless variant is based on a technique called Huffman encoding, which is used to compress data by assigning shorter codes to more frequent symbols. This process involves building a binary tree where each symbol corresponds to a unique path from the root to a leaf node. The tree is then used to encode and decode the data efficiently.

To illustrate this concept, consider a simple example where we have four symbols (A, B, C, and D) with varying frequencies. The Huffman tree for these symbols might look like this:

```
       root
      /    \
     A      root
           /    \
          B      root
                /    \
               C      D
```

In this tree, the symbol A is encoded as `0`, B as `10`, C as `110`, and D as `111`. When encoding a sequence of symbols, we traverse the tree from the root to the leaf node corresponding to each symbol, generating a binary code along the way. This process ensures that more frequent symbols are assigned shorter codes, reducing the overall size of the encoded data.

Huffman tables are used to store the mapping between symbols and their corresponding codes. These tables are typically constructed during the encoding process and are required for decoding the data. For the example above, the Huffman table might look like this:

```
Symbol | Code
-------|-----
A      | 0
B      | 10
C      | 110
D      | 111
```

In the case of WebP, the Huffman tree is stored in the image file along with the encoded pixel data. When the image is decoded, the tree is reconstructed, and the pixel data is decoded using the tree's structure. This process is typically straightforward and efficient, but it can become complex when dealing with malformed or maliciously crafted images.

## The WebP Vulnerability (CVE-2023-4863)

In September 2023, a critical vulnerability was discovered in the WebP image format that allowed attackers to execute arbitrary code on a victim's machine. The vulnerability, assigned CVE-2023-4863, was caused by a heap buffer overflow in the Huffman decoding process. By crafting a specially designed WebP image, an attacker could trigger the overflow and overwrite memory in the decoder, leading to a variety of potential exploits.

When a vulnerable system attempts to decode the maliciously crafted WebP image, the Huffman tree construction and traversal process result in a memory corruption vulnerability. This vulnerability can then be exploited by an attacker to execute arbitrary code with the same privileges as the process handling the WebP image.

But triggering the vulnerability is not as simple as sending a malicious image file to a victim. The attacker must carefully construct the image to exploit the specific conditions that trigger the heap buffer overflow. This requires a deep understanding of the WebP format and the internal workings of the decoder, making it a non-trivial task even for experienced security researchers.

To recreate the vulnerability, we need to:

1. Construct a sequence of 4 valid Huffman tables that are maximally sized for two different alphabet sizes (280 and 256).

2. Next, construct a very specific type of invalid Huffman table for a third alphabet size (40).

3. Finally, the vulnerability will be manifested in the `HuffmanTreeGroup::BuildHuffmanTrees` function in the `libwebp` library when the invalid Huffman table is processed. Due to a flaw in the memory allocation logic, the function can be coerced into writing data beyond the allocated buffer, leading to an out-of-bounds write and potential memory corruption.

If any step is not followed correctly, the vulnerability will not be triggered and the image decoder will simply throw an error. Practically, this means that exploiting the vulnerability requires a high level of expertise and knowledge of the WebP format, making it unlikely to be used in widespread attacks.

## The Implications of the WebP Vulnerability

The discovery of the WebP vulnerability highlights the importance of scrutinizing even seemingly innocuous file formats for potential security flaws. While image formats are not typically associated with security risks, they can be a vector for attacks when implemented incorrectly or when vulnerabilities are present. In the case of WebP, the vulnerability was hidden deep within the image decoding process, requiring a detailed understanding of the format and its implementation to exploit.

## Conclusion

The WebP vulnerability serves as a reminder that security vulnerabilities can lurk in unexpected places, even in seemingly benign image formats. As software systems become more complex and interconnected, it is essential to conduct thorough security assessments of all components, including image decoders and parsers. By identifying and addressing vulnerabilities proactively, we can help prevent potential exploits and protect users from malicious attacks.

## References

\- [Uncovering the Hidden WebP vulnerability: a tale of a CVE with much bigger implications than it originally seemed](https://blog.cloudflare.com/uncovering-the-hidden-webp-vulnerability-cve-2023-4863) \
\- [CVE-2023-4863 Detail](https://www.cvedetails.com/cve/CVE-2023-4863) \
\- [WEBPâ€™S WEAK SPOT: UNVEILING THE HIDDEN VULNERABILITY](<https://prisminfosec.com/webps-weak-spot-unveiling-the-hidden-vulnerability/#:~:text=Last%20month%20(September%202023)%2C,under%20CVE%2D2023%2D4863.>) \
\- [The WebP 0day](https://blog.isosceles.com/the-webp-0day/) \
\- [Explanation from the Youtube channel Low Level Learning](https://www.youtube.com/watch?v=89ysXVYH2Sk)

{{ utterances()}}
